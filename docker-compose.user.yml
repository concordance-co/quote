# Generated by concord-cli 0.3.0
# Services pull published images and expose health endpoints so Docker
# Compose can orchestrate dependencies without building from source.
services:
  postgres:
    image: postgres:16
    container_name: concord-postgres
    environment:
      POSTGRES_DB: ${CONCORD_POSTGRES_DB:-concord}
      POSTGRES_PASSWORD: ${CONCORD_POSTGRES_PASSWORD:-concord}
      POSTGRES_USER: ${CONCORD_POSTGRES_USER:-concord}
    ports:
      - "${CONCORD_POSTGRES_PORT:-5432}:5432"
    volumes:
      - concord-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    image: ${CONCORD_BACKEND_IMAGE:-ghcr.io/your-org/concord-backend:0.3.0}
    container_name: concord-backend
    depends_on:
      postgres:
        condition: service_healthy
    env_file:
      - .env
    environment:
      DATABASE_URL: ${CONCORD_DATABASE_URL}
      APP_HOST: 0.0.0.0
      APP_PORT: 6767
    ports:
      - "${CONCORD_BACKEND_PORT:-6767}:6767"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:6767/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  engine:
    image: ${CONCORD_ENGINE_IMAGE:-ghcr.io/your-org/concord-engine:0.3.0}
    container_name: concord-engine
    platform: linux/amd64
    depends_on:
      - backend
    env_file:
      - .env
    environment:
      PORT: 8000
      CONCORD_BACKEND_URL: http://backend:6767
      MODEL_ID: "${CONCORD_MODEL_ID:-modularai/Llama-3.1-8B-Instruct-GGUF}"
      HF_HOME: /models/hf
      HF_HUB_CACHE: /models/hf/hub
      HF_HUB_ENABLE_HF_TRANSFER: "1"
      HF_HUB_VERBOSITY: "info"
    ports:
      - "${CONCORD_ENGINE_PORT:-8000}:8000"
    # Health checks intentionally omitted; model initialization can take time.
    volumes:
      - concord-engine-models:/models
      - concord-engine-mef:/root/.local/share/modular/.max_cache/mof/mef
      - concord-engine-logic:/logic

  frontend:
    image: ${CONCORD_FRONTEND_IMAGE:-ghcr.io/your-org/concord-frontend:0.3.0}
    container_name: concord-frontend
    depends_on:
      backend:
        condition: service_healthy
      engine:
        condition: service_started
    env_file:
      - .env
    environment:
      CONCORD_BACKEND_URL: http://backend:6767
      CONCORD_ENGINE_URL: http://engine:8000
      PORT: 5173
    ports:
      - "${CONCORD_FRONTEND_PORT:-5173}:5173"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:5173/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

volumes:
  concord-postgres-data:
  concord-engine-models:
  concord-engine-mef:
  concord-engine-logic:
